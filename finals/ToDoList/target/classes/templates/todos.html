<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Todos - [[${username}]]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #6dd5ed, #2193b0);
            min-height: 100vh;
            padding: 40px;
            font-family: Arial, sans-serif;
        }
        .todo-container {
            max-width: 800px;
            margin: auto;
            background: #fff;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        h2 { color: #2193b0; text-align: center; margin-bottom: 20px; }
        .completed { text-decoration: line-through; color: gray; }
    </style>
</head>
<body>
<div class="todo-container">
    <div class="d-flex justify-content-between mb-3">
    <h2 th:text="'Todos for ' + ${username}"></h2>
    <form th:action="@{/logout}" method="post">
        <button type="submit" class="btn btn-danger">Logout</button>
    </form>
</div>
    
    

    <!-- Add Todo Form -->
    <div class="mb-3">
        <input type="text" id="taskName" placeholder="Task Name" class="form-control mb-2">
        <input type="text" id="description" placeholder="Description" class="form-control mb-2">
        <input type="datetime-local" id="dueDate" class="form-control mb-2">
        <button class="btn btn-success w-100" onclick="addTodo()">Add Todo</button>
    </div>

    <!-- Todo Table -->
    <table class="table table-hover table-striped" id="todoTable">
        <thead class="table-dark">
            <tr>
                <th>Task</th>
                <th>Description</th>
                <th>Due Date</th>
                <th>Status</th>
                <th style="width:180px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="todo : ${todos}" th:id="'todo-' + ${todo.id}">
                <td th:text="${todo.taskName}" th:classappend="${todo.completed} ? 'completed' : ''"></td>
                <td th:text="${todo.description}"></td>
                <td th:text="${todo.dueDate != null ? #temporals.format(todo.dueDate, 'yyyy-MM-dd\'T\'HH:mm') : 'No Due Date'}"></td>
                <td>
                    <span th:text="${todo.completed} ? 'Completed' : 'Pending'"
                          th:classappend="${todo.completed} ? 'badge bg-success' : 'badge bg-warning'"></span>
                </td>
                <td>
                    <input type="checkbox" th:checked="${todo.completed}" 
                           onchange="toggleComplete([[${todo.id}]], this.checked)">
                    <a href="javascript:void(0)" class="btn btn-sm btn-danger" onclick="deleteTodo([[${todo.id}]])">Delete</a>
                </td>
            </tr>
        </tbody>
    </table>

    <p th:if="${#lists.isEmpty(todos)}" class="text-center text-muted">No tasks yet. Add one!</p>
</div>

<script>
    const username = /*[[${username}]]*/ 'user';

    async function addTodo() {
        const taskName = document.getElementById('taskName').value;
        const description = document.getElementById('description').value;
        const dueDate = document.getElementById('dueDate').value || null;

        if (!taskName) return alert('Task Name is required');

        const response = await fetch('/todos/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ taskName, description, dueDate })
        });

        const todo = await response.json();
        const tbody = document.querySelector('#todoTable tbody');

        const tr = document.createElement('tr');
        tr.id = `todo-${todo.id}`;
        tr.innerHTML = `
            <td>${todo.taskName}</td>
            <td>${todo.description || ''}</td>
            <td>${todo.dueDate ? new Date(todo.dueDate).toISOString().slice(0,16) : 'No Due Date'}</td>
            <td><span class="badge bg-warning">Pending</span></td>
            <td>
                <input type="checkbox" onchange="toggleComplete(${todo.id}, this.checked)">
                <a href="javascript:void(0)" class="btn btn-sm btn-danger" onclick="deleteTodo(${todo.id})">Delete</a>
            </td>
        `;
        tbody.appendChild(tr);

        document.getElementById('taskName').value = '';
        document.getElementById('description').value = '';
        document.getElementById('dueDate').value = '';
    }

    async function toggleComplete(id, completed) {
        await fetch(`/todos/complete/${id}?completed=${completed}`, { method: 'POST' });

        const row = document.getElementById(`todo-${id}`);
        const statusCell = row.querySelector('td:nth-child(4) span');
        const taskCell = row.querySelector('td:first-child');

        if (completed) {
            statusCell.textContent = 'Completed';
            statusCell.className = 'badge bg-success';
            taskCell.classList.add('completed');
        } else {
            statusCell.textContent = 'Pending';
            statusCell.className = 'badge bg-warning';
            taskCell.classList.remove('completed');
        }
    }

    async function deleteTodo(id) {
        if (!confirm("Are you sure you want to delete this task?")) return;

        const response = await fetch(`/todos/delete/${id}`, { method: 'DELETE' });

        if (response.ok) {
            document.getElementById(`todo-${id}`).remove();
        } else {
            alert("Failed to delete task");
        }
    }
</script>
</body>
</html>
